name: Publish to Snapcraft

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name (e.g., 0.4.4)'
        required: true

concurrency:
  group: snap-${{ inputs.version_name }}
  cancel-in-progress: false

env:
  BIN_NAME: yadaw  # Set your binary name here

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Preflight | Check release tag
        run: |
          curl -fsSL "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ inputs.version_name }}" >/dev/null

      - name: Preflight | Check secret
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        run: |
          [ -n "$SNAPCRAFT_STORE_CREDENTIALS" ] || { echo "Missing secret SNAPCRAFT_TOKEN" >&2; exit 1; }

      - name: Fetch Linux binary (from tar.gz)
        run: |
          set -euo pipefail
          mkdir -p others/snap/snap/builds others/snap/snap/gui

          # Copy desktop and icon files
          cp others/flathub/io.github.mlm_games.yadaw.desktop others/snap/snap/gui/yadaw.desktop
          cp fastlane/metadata/android/en-US/images/icon.png others/snap/snap/gui/icon.png
          sed -i -e 's|^Exec=.*|Exec=yadaw|' \
                 -e 's|^Icon=.*|Icon=${SNAP}/meta/gui/icon.png|' \
                 others/snap/snap/gui/yadaw.desktop

          VERSION="${{ inputs.version_name }}"
          TARGET="x86_64-unknown-linux-gnu" 
          TAR_GZ_FILE="${{ env.BIN_NAME }}-${VERSION}-${TARGET}.tar.gz"
          curl -fL "https://github.com/${{ github.repository }}/releases/download/${{ inputs.version_name }}/$TAR_GZ_FILE" -o /tmp/app.tar.gz

          # Extract tar.gz and copy binary
          mkdir -p /tmp/app_extract
          tar -xzf /tmp/app.tar.gz -C /tmp/app_extract
          cp "/tmp/app_extract/${{ env.BIN_NAME }}-${VERSION}-${TARGET}/${{ env.BIN_NAME }}" "others/snap/snap/builds/${{ env.BIN_NAME }}"
          chmod +x others/snap/snap/builds/${{ env.BIN_NAME }}


      - name: Update version in snapcraft.yml
        run: |
          sed -i "s/^version: .*/version: '${{ inputs.version_name }}'/" others/snap/snapcraft.yaml
          echo "others/snap/snapcraft.yaml version updated"

      - name: Build snap
        uses: snapcore/action-build@v1
        id: build
        with:
          path: others/snap

      - name: Publish to Snap Store
        uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        with:
          snap: ${{ steps.build.outputs.snap }}
          release: stable
